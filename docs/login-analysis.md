# ログイン機能 分析・改善計画

## 現在の問題

### 観察された症状
- コンソールに `[Auth] /api/auth/me failed: HttpError: Invalid session cookie` が繰り返し表示される
- セッションクッキーが正しく設定されていない可能性がある

### 根本原因の仮説

#### 1. クッキー設定の問題
- テスト環境でのクッキードメイン設定が不適切
- `SameSite=none` + `Secure=true` の組み合わせでクロスオリジンリクエストが失敗
- ローカル開発環境での HTTPS/HTTP の混在

#### 2. OAuth フロー の問題
- OAuth コールバック後のセッション生成が失敗
- トークン検証時にセッションクッキーが失われている
- リダイレクト時のクッキー保持の問題

#### 3. API リクエスト の問題
- `/api/auth/me` エンドポイントへのリクエストでクッキーが送信されていない
- CORS設定によるクッキー送信の制限

## 改善計画

### Phase 1: 問題の特定
- [ ] ネットワークタブでクッキーの送受信を確認
- [ ] OAuth コールバック後のセッション状態を確認
- [ ] `/api/auth/me` リクエストのクッキーヘッダーを確認
- [ ] CORS設定を確認

### Phase 2: ログイン機能の改善

#### 2.1 セッション管理の強化
- セッションクッキーの有効期限を明確に設定
- セッションストレージ（サーバー側）の実装確認
- クッキーの署名と検証メカニズムの確認

#### 2.2 OAuth フロー の改善
- OAuth コールバック後の確実なセッション生成
- トークンの安全な保存
- リフレッシュトークンの実装

#### 2.3 クライアント側の改善
- `useAuth` フックの改善
  - リトライロジックの追加
  - エラーハンドリングの改善
  - ローディング状態の管理
- API リクエストの設定
  - `credentials: 'include'` の確認
  - クッキー送信の明示的な設定

#### 2.4 ゲストモードからのシームレスな移行
- ゲストユーザーのデータをログイン後に保持
- ローカルストレージのデータをサーバーに同期
- ユーザー体験の向上

### Phase 3: テストの追加
- ログイン フロー のユニットテスト
- OAuth コールバック のテスト
- セッション管理 のテスト
- E2E テスト でのログイン検証

## 実装優先度

1. **高**: クッキー送信の確認と CORS 設定の修正
2. **高**: OAuth フロー の改善
3. **中**: セッション管理の強化
4. **中**: ゲストモードからの移行機能
5. **低**: リフレッシュトークンの実装

## 関連ファイル

- `hooks/use-auth.ts` - 認証状態管理
- `server/_core/oauth.ts` - OAuth実装
- `server/_core/cookies.ts` - クッキー管理
- `lib/api.ts` - API リクエスト設定
- `app/oauth/callback.tsx` - OAuth コールバック処理
